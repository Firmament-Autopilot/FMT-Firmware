# MLog 解析器 (parse_mlog.py)

这是一个用于解析 FMT 固件生成的二进制日志文件 (mlog) 的 Python 工具。该工具可以将二进制日志文件转换为易于分析的 CSV 格式。

## 功能特性

- **完整的头部解析**：支持解析日志版本、时间戳、描述信息、模型信息等
- **消息数据解析**：将二进制消息数据转换为 CSV 格式
- **参数信息解析**：解析并显示所有参数组和参数值
- **自动类型检测**：支持多种数据类型（INT8, UINT8, INT16, UINT16, INT32, UINT32, FLOAT, DOUBLE, BOOLEAN）
- **时间戳计算**：自动计算消息间的时间间隔（delta_ts）

## 系统要求

- Python 3.6 或更高版本
- 标准库模块：`os`, `re`, `sys`, `csv`, `struct`, `pathlib`

## 安装

无需额外安装，脚本使用 Python 标准库。

## 使用方法

### 基本用法

```bash
cd python
python parse_mlog.py
```

脚本会自动在以下位置查找 `mlog1.bin` 文件：
1. 项目根目录
2. 当前工作目录

### 手动指定文件

将 `mlog1.bin` 文件放在 `python` 目录下，然后运行：

```bash
cd python
python parse_mlog.py
```

## 输出说明

### 控制台输出

脚本运行时会显示以下信息：

```
解析头部成功: version=2, timestamp=1234567890, num_bus=5
名称长度=25, 描述长度=128, 模型信息长度=256
描述信息: 飞行测试日志
模型信息: INS模型信息\nFMS模型信息\n控制模型信息
参数组数量: 3
  参数组: SYSTEM, 参数数量: 10
    SYS_HITL: UINT8 = 0
    SYS_SIH: UINT8 = 0
    ...
  参数组: INS, 参数数量: 15
    INS_USE_GPS: UINT8 = 1
    INS_GPS_LEV: FLOAT = 0.000000
    ...
总消息种类: 5
msg_id=0 'INS_Out': 帧数=1250
msg_id=1 'FMS_Out': 帧数=1250
...
解析完成。CSV 输出目录: /path/to/python/out
```

### CSV 文件输出

脚本会在 `out` 目录下为每个消息类型生成一个 CSV 文件：

- `mlog_msg_0_INS_Out.csv` - INS 输出消息
- `mlog_msg_1_FMS_Out.csv` - FMS 输出消息
- `mlog_msg_2_Control_Out.csv` - 控制输出消息
- ...

每个 CSV 文件包含：
- 消息的所有字段列
- `delta_ts` 列：与上一帧的时间间隔（毫秒）

## 文件结构

```
python/
├── parse_mlog.py          # 主解析脚本
├── mlog1.bin             # 二进制日志文件（需要用户提供）
├── out/                  # 输出目录（自动创建）
│   ├── mlog_msg_0_INS_Out.csv
│   ├── mlog_msg_1_FMS_Out.csv
│   └── ...
└── README.md             # 本文档
```

## 支持的日志格式

### 消息格式

每个消息遵循以下二进制格式：
```
[MLOG_BEGIN_MSG1][MLOG_BEGIN_MSG2][MSG_ID][PAYLOAD][MLOG_END_MSG]
```

其中：
- `MLOG_BEGIN_MSG1 = 0x92`
- `MLOG_BEGIN_MSG2 = 0x05`
- `MLOG_END_MSG = 0x26`

### 支持的数据类型

| 类型 | 大小 | 说明 |
|------|------|------|
| INT8 | 1 字节 | 8位有符号整数 |
| UINT8 | 1 字节 | 8位无符号整数 |
| INT16 | 2 字节 | 16位有符号整数 |
| UINT16 | 2 字节 | 16位无符号整数 |
| INT32 | 4 字节 | 32位有符号整数 |
| UINT32 | 4 字节 | 32位无符号整数 |
| FLOAT | 4 字节 | 32位浮点数 |
| DOUBLE | 8 字节 | 64位浮点数 |
| BOOLEAN | 1 字节 | 布尔值（0/1） |

## 错误处理

脚本包含完善的错误处理机制：

- **文件未找到**：如果找不到 `mlog1.bin` 文件，会显示提示信息
- **文件格式错误**：如果文件格式不正确，会显示解析错误信息
- **数据同步丢失**：如果消息格式损坏，会自动尝试重新同步

## 常见问题

### Q: 脚本提示"未找到 mlog1.bin 文件"
A: 请确保 `mlog1.bin` 文件位于 `python` 目录下，或者将文件放在项目根目录。

### Q: 解析出的 CSV 文件为空
A: 检查原始日志文件是否包含有效的消息数据，或者文件是否损坏。

### Q: 时间戳计算不准确
A: 脚本使用消息中的 `timestamp` 字段计算时间间隔。如果该字段不存在或格式不正确，`delta_ts` 将显示为 0。

## 技术细节

### 头部解析

脚本会解析以下头部信息：
- 版本号
- 时间戳
- 最大名称长度
- 描述信息（如果启用）
- 模型信息（如果启用）
- 消息总线定义
- 参数组和参数定义

### 消息解析

- 自动检测消息边界
- 支持消息同步恢复
- 按消息类型分组输出
- 自动计算时间间隔

## 许可证

本工具遵循与 FMT 固件相同的 Apache 2.0 许可证。

## 贡献

欢迎提交 Issue 和 Pull Request 来改进这个工具。

## 更新日志

### v1.1.0
- 添加参数信息解析支持
- 添加模型信息解析支持
- 改进错误处理和日志输出
- 优化 CSV 输出格式

### v1.0.0
- 初始版本
- 基本的消息解析功能
- CSV 输出支持
